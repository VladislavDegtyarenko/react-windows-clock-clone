/*!
 * Copyright (c) Microsoft Corporation. All rights reserved.
 * Licensed under the MIT License.
 */const y=typeof WeakRef!="undefined";class h{constructor(e){y&&typeof e=="object"?this._weakRef=new WeakRef(e):this._instance=e}deref(){var e,t,s;let i;return this._weakRef?(i=(e=this._weakRef)===null||e===void 0?void 0:e.deref(),i||delete this._weakRef):(i=this._instance,!((s=(t=i)===null||t===void 0?void 0:t.isDisposed)===null||s===void 0)&&s.call(t)&&delete this._instance),i}}/*!
 * Copyright (c) Microsoft Corporation. All rights reserved.
 * Licensed under the MIT License.
 */const l="keyborg:focusin";function g(o){const e=o.HTMLElement,t=e.prototype.focus;let s=!1;return e.prototype.focus=function(){s=!0},o.document.createElement("button").focus(),e.prototype.focus=t,s}let _=!1;function v(o){const e=o;_||(_=g(e));const t=e.HTMLElement.prototype.focus;if(t.__keyborgNativeFocus)return;e.HTMLElement.prototype.focus=i;const s=e.__keyborgData={focusInHandler:r=>{var a;const d=r.target;if(!d)return;const u=document.createEvent("HTMLEvents");u.initEvent(l,!0,!0);const f={relatedTarget:r.relatedTarget||void 0};(_||s.lastFocusedProgrammatically)&&(f.isFocusedProgrammatically=d===((a=s.lastFocusedProgrammatically)===null||a===void 0?void 0:a.deref()),s.lastFocusedProgrammatically=void 0),u.details=f,d.dispatchEvent(u)}};e.document.addEventListener("focusin",e.__keyborgData.focusInHandler,!0);function i(){const r=e.__keyborgData;return r&&(r.lastFocusedProgrammatically=new h(this)),t.apply(this,arguments)}i.__keyborgNativeFocus=t}function b(o){const e=o,t=e.HTMLElement.prototype,s=t.focus.__keyborgNativeFocus,i=e.__keyborgData;i&&(e.document.removeEventListener("focusin",i.focusInHandler,!0),delete e.__keyborgData),s&&(t.focus=s)}/*!
 * Copyright (c) Microsoft Corporation. All rights reserved.
 * Licensed under the MIT License.
 */const k=9,p=27,w=500;let m=0;class E{constructor(){this.__keyborgCoreRefs={},this._isNavigatingWithKeyboard=!1}add(e){const t=e.id;t in this.__keyborgCoreRefs||(this.__keyborgCoreRefs[t]=new h(e))}remove(e){delete this.__keyborgCoreRefs[e],Object.keys(this.__keyborgCoreRefs).length===0&&(this._isNavigatingWithKeyboard=!1)}setVal(e){if(this._isNavigatingWithKeyboard!==e){this._isNavigatingWithKeyboard=e;for(const t of Object.keys(this.__keyborgCoreRefs)){const i=this.__keyborgCoreRefs[t].deref();i?i.update(e):this.remove(t)}}}getVal(){return this._isNavigatingWithKeyboard}}const n=new E;class F{constructor(e){this._isMouseUsed=!1,this._onFocusIn=s=>{if(this._isMouseUsed){this._isMouseUsed=!1;return}if(n.getVal())return;const i=s.details;!i.relatedTarget||i.isFocusedProgrammatically||i.isFocusedProgrammatically===void 0||n.setVal(!0)},this._onMouseDown=s=>{s.buttons===0||s.clientX===0&&s.clientY===0&&s.screenX===0&&s.screenY===0||(this._isMouseUsed=!0,n.setVal(!1))},this._onKeyDown=s=>{const i=n.getVal();!i&&s.keyCode===k?n.setVal(!0):i&&s.keyCode===p&&this._scheduleDismiss()},this.id="c"+ ++m,this._win=e;const t=e.document;t.addEventListener(l,this._onFocusIn,!0),t.addEventListener("mousedown",this._onMouseDown,!0),e.addEventListener("keydown",this._onKeyDown,!0),v(e),n.add(this)}dispose(){const e=this._win;if(e){this._dismissTimer&&(e.clearTimeout(this._dismissTimer),this._dismissTimer=void 0),b(e);const t=e.document;t.removeEventListener(l,this._onFocusIn,!0),t.removeEventListener("mousedown",this._onMouseDown,!0),e.removeEventListener("keydown",this._onKeyDown,!0),delete this._win,n.remove(this.id)}}isDisposed(){return!!this._win}update(e){var t,s;const i=(s=(t=this._win)===null||t===void 0?void 0:t.__keyborg)===null||s===void 0?void 0:s.refs;if(i)for(const r of Object.keys(i))c.update(i[r],e)}_scheduleDismiss(){const e=this._win;if(e){this._dismissTimer&&(e.clearTimeout(this._dismissTimer),this._dismissTimer=void 0);const t=e.document.activeElement;this._dismissTimer=e.setTimeout(()=>{this._dismissTimer=void 0;const s=e.document.activeElement;t&&s&&t===s&&n.setVal(!1)},w)}}}class c{constructor(e){this._cb=[],this._id="k"+ ++m,this._win=e;const t=e.__keyborg;t?(this._core=t.core,t.refs[this._id]=this):(this._core=new F(e),e.__keyborg={core:this._core,refs:{[this._id]:this}})}static create(e){return new c(e)}static dispose(e){e.dispose()}static update(e,t){e._cb.forEach(s=>s(t))}dispose(){var e;const t=(e=this._win)===null||e===void 0?void 0:e.__keyborg;t!=null&&t.refs[this._id]&&(delete t.refs[this._id],Object.keys(t.refs).length===0&&(t.core.dispose(),delete this._win.__keyborg)),this._cb=[],delete this._core,delete this._win}isNavigatingWithKeyboard(){return n.getVal()}subscribe(e){this._cb.push(e)}unsubscribe(e){const t=this._cb.indexOf(e);t>=0&&this._cb.splice(t,1)}setVal(e){n.setVal(e)}}function T(o){return c.create(o)}function K(o){c.dispose(o)}export{l as K,T as c,K as d};
